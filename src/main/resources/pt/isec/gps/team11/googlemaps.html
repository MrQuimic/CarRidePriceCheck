<!DOCTYPE html>

<html>
<head>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places&key=AIzaSyDP1feUTnivFyTntFVr722y7SwOxsit7VQ&units=metric" async="" defer="defer" type="text/javascript"></script>

    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/distancematrix/json?destinations=Porto,Portugal&origins=Portimão,Portugal&units=imperial&key=AIzaSyDP1feUTnivFyTntFVr722y7SwOxsit7VQ"></script>

    <link rel="stylesheet" href="mystyle.css">
</head>

<body onload="initMap()">
<div id="locationField">
    <input id="autocomplete" placeholder="start autoComplete" onFocus="geolocate()" type="text"></input>
    <input id="autocomplete2" placeholder="end autoComplete" onFocus="geolocate()" type="text"></input>
    <input id="submit" type="submit" onclick="initMapjs()" value="go"></input>
    <!--<input id="reset" type="reset" onclick="ExibirGoogleMaps()" value="reset"></input>
     ##Only works in the browser##

    <button onclick="geoFindMe()">Show my location</button>

    <div id="out"></div>
    <button onclick="geoFindMe()">Show my location</button>-->
</div>
<div id="dvDistance">
</div>
<div id="macDiv"> </div>

<script type="text/javascript">

    const params = new URLSearchParams(window.location.search)

    let start, end, JSmap;


    function initialize() {
        autocomplete = new google.maps.places.Autocomplete(
            /** @type {HTMLInputElement} */(document.getElementById('autocomplete')),
            {types: ['geocode']});
        google.maps.event.addListener(autocomplete, 'place_changed', function () {
        });
        autocomplete2 = new google.maps.places.Autocomplete(
            /** @type {HTMLInputElement} */(document.getElementById('autocomplete2')),
            {types: ['geocode']});
        google.maps.event.addListener(autocomplete2, 'place_changed', function () {
        });
    }


    function geoFindMe() {
        var output = document.getElementById("out");

        if (!navigator.geolocation) {
            output.innerHTML = "<p>Geolocation is not supported by your browser</p>";
            return;
        }

        function success(position) {
            var loc = position.coords.latitude + ',' + position.coords.longitude;
            document.getElementById("autocomplete").value = loc;
        };

        function error() {
            output.innerHTML = "Unable to retrieve your location";
        };

        //output.innerHTML = "<p>Locating…</p>";

        navigator.geolocation.getCurrentPosition(success, error);
    };


    function initialize() {
        autocomplete = new google.maps.places.Autocomplete(
            /** @type {HTMLInputElement} */(document.getElementById('autocomplete')),
            {types: ['geocode']});
        google.maps.event.addListener(autocomplete, 'place_changed', function () {
        });
        autocomplete2 = new google.maps.places.Autocomplete(
            /** @type {HTMLInputElement} */(document.getElementById('autocomplete2')),
            {types: ['geocode']});
        google.maps.event.addListener(autocomplete2, 'place_changed', function () {
        });



    }
/*
    function initMapjs() {
        initialize();

        source = document.getElementById("autocomplete").value;
        destination = document.getElementById("autocomplete2").value;

        var directionsService = new google.maps.DirectionsService();
        var directionsRenderer = new google.maps.DirectionsRenderer();
        //var pointA = "Coimbra, Portugal",
        var pointA = source,
            pointB = destination,
            myOptions = {
                center: pointA,
                zoom: 15,
                minZoom: 1,
                mapTypeControl: false,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                unitSystem: google.maps.UnitSystem.METRIC,
                streetViewControl: false,
                avoidHighways: false,
                disableDefaultUI: false,
                avoidTolls: false

            },
            map = new google.maps.Map(document.getElementById('macDiv'), myOptions);
        directionsRenderer.setMap(map);

        directionsService = new google.maps.DirectionsService,
            directionsDisplay = new google.maps.DirectionsRenderer({
                draggable: true,
                travelMode: google.maps.TravelMode.DRIVING,
                map,
                panel: document.getElementById("panel"),
            }),

            markerA = new google.maps.Marker({
                position: pointA,
                title: "point A",
                label: "A",
                map: map
            }),
            markerB = new google.maps.Marker({
                position: pointB,
                title: "point B",
                label: "B",
                map: map
            });

        directionsService.route(request, function (response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
            }
        });

        source = pointA;
        destination = pointB;

        var request = {
            origin: source,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING
        };
        directionsService.route(request, function (response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
            }
        });

        // *********DISTANCE AND DURATION********************** //
        var service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix({
            origins: [source],
            destinations: [destination],
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC,
            avoidHighways: false,
            avoidTolls: false
        }, function (response, status) {
            if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
                var distance = response.rows[0].elements[0].distance.text;
                var duration = response.rows[0].elements[0].duration.text;
                var dvDistance = document.getElementById("dvDistance");
                var dist =  distance.slice(0, -3).replaceAll(',','');
                var price = dist*1.5;
                dvDistance.innerHTML = "";
                dvDistance.innerHTML += "Distance: " + distance + " | ";
                dvDistance.innerHTML += "Duration:" + duration + "<br />";
                dvDistance.innerHTML += "Price:" + price + " \u20AC";

            } else {
                alert("Unable to find the distance via road.");
            }
        });

        // get route from A to B
        calculateAndDisplayRoute(directionsService, directionsDisplay, pointA, pointB);

        google.maps.event.clearListeners(map);

    }
*/

function initMapjs(){
        JSmap="on";
        initMap();
}


    function initMap() {

        //Cria opções ou um conjunto de recursos no Google Map
        let resumeinfo;
        if(!params.has("origin") && JSmap !== "on"){
            initialize();
            start = new google.maps.LatLng(40.192866977423314, -8.411561405441944); //ISEC
            //end = new google.maps.LatLng(40.192866977423314, -8.411561405441944); //ISEC
            resumeinfo="off";
        }else if(JSmap !== "on"){
            initialize();
            start = params.get('origin');
            end = params.get('destin');
            resumeinfo="on";
        }else{
            start = document.getElementById("autocomplete").value;
            end = document.getElementById("autocomplete2").value;
            resumeinfo="on";
            if(start==="" || end===""){
                start = new google.maps.LatLng(40.192866977423314, -8.411561405441944); //ISEC
                end="";
                JSmap="off";
                resumeinfo="off";
                var dvDistance = document.getElementById("dvDistance");
                dvDistance.innerHTML = "";
                document.getElementById("autocomplete").value = "";
                document.getElementById("autocomplete2").value ="";
            }


        }

        let directionsDisplay = new google.maps.DirectionsRenderer();
        let directionsService = new google.maps.DirectionsService();
        let directionsRenderer = new google.maps.DirectionsRenderer();
        //var pointA = "Coimbra, Portugal",
        let pointA = start,
            pointB = end,
            myOptions = {
                origin: start,
                center: pointA,
                zoom: 15,
                minZoom: 1,
                mapTypeControl: true,
                travelMode: google.maps.DirectionsTravelMode.DRIVING,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                unitSystem: google.maps.UnitSystem.METRIC,
                streetViewControl: false,
                avoidHighways: false,
                disableDefaultUI: false,
                avoidTolls: false

            };
            map = new google.maps.Map(document.getElementById('macDiv'), myOptions);
        directionsRenderer.setMap(map);

        directionsService = new google.maps.DirectionsService,
            directionsDisplay = new google.maps.DirectionsRenderer({
                draggable: true,
                travelMode: google.maps.TravelMode.DRIVING,
                map,
                panel: document.getElementById("panel"),
            });
      //  addYourLocationButton(map, myMarker);
        google.maps.event.clearListeners(map);
        var myMarker = new google.maps.Marker({
            map: map,
            animation: google.maps.Animation.DROP
        });

        if(!params.has("origin") && JSmap !== "on"){
            var marcador = new google.maps.Marker({
                position: meuEndereco,
                animation: google.maps.Animation.BOUNCE,
            });

        }else{
            markerA = new google.maps.Marker({
                position: pointA,
                title: "point A",
                label: "A",
                map: map
            });
            markerB = new google.maps.Marker({
                position: pointB,
                title: "point B",
                label: "B",
                map: map
            });

        }
        directionsService.route(request, function (response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
            }
        });

        source = pointA;
        destination = pointB;

        var request = {
            origin: source,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING
        };
        directionsService.route(request, function (response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
            }
        });
        if(resumeinfo==="on"){
            //*********DISTANCE AND DURATION**********************//
            let service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({
                origins: [source],
                destinations: [destination],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false
            }, function (response, status) {
                if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
                    var distance = response.rows[0].elements[0].distance.text;
                    var duration = response.rows[0].elements[0].duration.text;
                    var dvDistance = document.getElementById("dvDistance");
                    var dist = distance.slice(0, -3).replaceAll(',', '');
                    var price = dist * 1.5;
                    dvDistance.innerHTML = "";
                    dvDistance.innerHTML += "Distance: " + distance + " | ";
                    dvDistance.innerHTML += "Duration:" + duration + "<br />";
                    dvDistance.innerHTML += "Price:" + price + " \u20AC";

                } else {
                    alert("Unable to find the distance via road.");
                }
            });

            // get route from A to B
            calculateAndDisplayRoute(directionsService, directionsDisplay, pointA, pointB);

        }else{

            var dvDistance = document.getElementById("dvDistance");
            dvDistance.innerHTML = "";

        }

    }


    function calculateAndDisplayRoute(directionsService, directionsDisplay, distinationOrigin, destinationMarker) {
        directionsService.route({
            origin: distinationOrigin,
            destination: destinationMarker,
            travelMode: google.maps.TravelMode.DRIVING
        }, function(response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
            } else {
                window.alert('Directions request failed due to ' + status);
            }
        });

    }

    function addYourLocationButton (map, marker) {
        var controlDiv = document.createElement('div');

        var firstChild = document.createElement('button');
        firstChild.style.backgroundColor = '#fff';
        firstChild.style.border = 'none';
        firstChild.style.outline = 'none';
        firstChild.style.width = '28px';
        firstChild.style.height = '28px';
        firstChild.style.borderRadius = '2px';
        firstChild.style.boxShadow = '0 1px 4px rgba(0,0,0,0.3)';
        firstChild.style.cursor = 'pointer';
        firstChild.style.marginRight = '10px';
        firstChild.style.padding = '0';
        firstChild.title = 'Your Location';
        controlDiv.appendChild(firstChild);

        var secondChild = document.createElement('div');
        secondChild.style.margin = '5px';
        secondChild.style.width = '18px';
        secondChild.style.height = '18px';
        secondChild.style.backgroundImage = 'url(https://maps.gstatic.com/tactile/mylocation/mylocation-sprite-2x.png)';
        secondChild.style.backgroundSize = '180px 18px';
        secondChild.style.backgroundPosition = '0 0';
        secondChild.style.backgroundRepeat = 'no-repeat';
        firstChild.appendChild(secondChild);

        google.maps.event.addListener(map, 'center_changed', function () {
            secondChild.style['background-position'] = '0 0';
        });

        firstChild.addEventListener('click', function () {
            var imgX = 0,
                animationInterval = setInterval(function () {
                    imgX = -imgX - 18 ;
                    secondChild.style['background-position'] = imgX+'px 0';
                }, 500);

            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    map.setCenter(latlng);
                    clearInterval(animationInterval);
                    secondChild.style['background-position'] = '-144px 0';
                });
            } else {
                clearInterval(animationInterval);
                secondChild.style['background-position'] = '0 0';
            }
        });

        controlDiv.index = 1;
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(controlDiv);
    }




   // var zoom = map.getZoom();
    //map.setZoom(zoom+1);
    //map.setZoom(zoom);

</script>
</body>
</html>
